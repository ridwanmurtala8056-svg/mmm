# SMC Trading Bot

## Overview

A Telegram-based cryptocurrency trading bot that uses Smart Money Concepts (SMC) for market analysis. The application provides automated trading signals and execution on the Solana blockchain through Jupiter DEX integration. The web frontend is minimal by design‚Äîall trading functionality is accessed through the Telegram bot interface.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Routing**: Wouter (lightweight router)
- **State Management**: TanStack React Query for server state
- **UI Components**: shadcn/ui component library built on Radix UI primitives
- **Styling**: Tailwind CSS with CSS variables for theming
- **Build Tool**: Vite with React plugin

The frontend displays a simple message directing users to Telegram since all trading functionality is accessed through the bot interface.

### Backend Architecture
- **Runtime**: Node.js with Express
- **Language**: TypeScript (ESM modules)
- **Entry Point**: `server/index.ts`

Key server modules:
- `server/telegram.ts` - Telegram bot setup and command handling using node-telegram-bot-api
- `server/signals-worker.ts` - Automated signal generation using AI analysis
- `server/solana.ts` - Jupiter DEX integration for Solana swaps with multi-endpoint fallback
- `server/storage.ts` - Database abstraction layer with AES-256-CBC encryption for sensitive data
- `server/ai.ts` - OpenAI/OpenRouter integration for market analysis
- `server/db.ts` - Database connection using Drizzle ORM

### Data Storage
- **Database**: Supabase PostgreSQL (Optional) / Local SQLite (Fallback)
- **ORM**: Drizzle ORM
- **Schema Location**: `shared/schema.ts`
- **Migration Policy**: The bot uses a local SQLite database (`local.db`) by default if `DATABASE_URL` is not provided. It automatically synchronizes with Supabase for centralized storage and backups if Supabase credentials (URL, Anon Key, Service Role Key) are provided.

Database tables:
- `users` - Telegram user profiles and trading preferences (safety profile, fee tiers, MEV protection settings)
- `wallets` - Encrypted Solana wallet storage
- `signals` - Trading signals generated by the system
- `trades` - Trade execution history
- `user_lanes` - User-specific signal lane configurations (high/med/low priority)
- `group_bindings` - Telegram group/topic bindings for signal distribution
- `user_subscriptions` - Subscription management

### Security
- Wallet private keys are encrypted using AES-256-CBC before database storage
- Master encryption key derived from `SESSION_SECRET` environment variable
- Sensitive operations require proper authentication through Telegram user IDs

## Data Persistence & Safety

To ensure your trading data, wallets, and settings are never lost:

### 1. Maintain Secrets
The bot uses your **Secrets** to encrypt wallet data. Specifically:
- **SESSION_SECRET**: This is the "Master Key". If you change this, your old wallets will become unreadable. **Always use the same SESSION_SECRET** when moving the bot to a new project.
- **DATABASE_URL**: (Optional) This connects the bot to your PostgreSQL database. If omitted, the bot will use a local SQLite file.

### 2. Database Backups
Replit handles the database hosting if you use their Postgres, but you can protect your data by:
- **Agent Checkpoints**: Every time the Agent makes a change, a checkpoint is created. You can roll back to a previous checkpoint to restore both your code and your database state.
- **Supabase Synchronization**: If you provide Supabase credentials, the bot will automatically backup your data every 30 minutes.

### 3. Moving the Bot
When moving the bot to a new workspace:
1. Copy all **Secrets** (TELEGRAM_BOT_TOKEN, SESSION_SECRET, etc.).
2. If you want to keep your data, ensure either the **DATABASE_URL** is correctly set to point to your existing database, or provide **Supabase credentials** to restore your data.
3. If the database is empty and no backup is found, the bot will start fresh.

### 4. Security Best Practice
- **Keep your private keys!** Even with database backups, always keep a manual backup of your Solana private keys. The bot allows you to export them via `/settings` -> `Wallets` -> `üóù Export Private Key`.

### Required Environment Variables
- `TELEGRAM_BOT_TOKEN` - Telegram Bot API token
- `SESSION_SECRET` - Master key for wallet encryption
- `DATABASE_URL` - (Optional) PostgreSQL connection string. If missing, the bot uses a local SQLite file.
- `SUPABASE_URL` - (Optional) Supabase project URL for backups
- `SUPABASE_ANON_KEY` - (Optional) Supabase anon key
- `SUPABASE_SERVICE_ROLE_KEY` - (Optional) Supabase service role key (required for backups)
- `SOLANA_RPC_URL` - Solana RPC endpoint (defaults to mainnet-beta)

### AI Integration (one required)
- `AI_INTEGRATIONS_OPENAI_API_KEY` or `OPENAI_API_KEY` - OpenAI API key
- `OPENROUTER_API_KEY` - OpenRouter API key (with optional `OPENROUTER_BASE_URL`)

### Third-Party Services
- **Jupiter Aggregator** - DEX aggregation for Solana token swaps (multiple fallback endpoints configured)
- **Telegram Bot API** - User interface and command handling via node-telegram-bot-api
- **OpenAI/OpenRouter** - AI-powered market analysis and signal generation using Gemini 2.0 Flash model
- **Solana Web3.js** - Blockchain interaction for wallet management and transaction execution

### Key NPM Dependencies
- `@solana/web3.js` - Solana blockchain interaction
- `@jup-ag/api` - Jupiter DEX API client
- `node-telegram-bot-api` - Telegram bot framework
- `drizzle-orm` - Database ORM with PostgreSQL dialect
- `openai` - OpenAI/OpenRouter API client
- `bs58` - Base58 encoding for Solana keys
